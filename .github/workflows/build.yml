name: Build APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Buildozer Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-dev \
            openjdk-11-jdk-headless \
            wget unzip git curl \
            zlib1g-dev \
            libncurses5-dev \
            libssl-dev \
            libffi-dev \
            autoconf automake libtool \
            pkg-config \
            cmake \
            ninja-build \
            ccache
          
      - name: Install Buildozer and Cython
        run: |
          pip3 install --upgrade pip wheel setuptools
          pip3 install cython==0.29.33
          pip3 install buildozer==1.5.0
          
      - name: Initialize Buildozer
        run: |
          # ایجاد فایل spec اگر وجود ندارد
          if [ ! -f buildozer.spec ]; then
            buildozer init
          fi
          
      - name: Build APK
        run: |
          # ساخت با تنظیمات بهینه
          export BUILD_MAX_JOBS=2
          buildozer -v android debug 2>&1 | tail -100
          
      - name: List Generated Files
        run: |
          echo "=== فایل‌های APK ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "هیچ فایل APK یافت نشد"
          echo "=== محتوای پوشه bin ==="
          ls -la bin/ 2>/dev/null || echo "پوشه bin وجود ندارد"
          
      - name: Upload APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: bin/*.apk
          if-no-files-found: error
          retention-days: 7
