name: Build APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          sudo apt update
          sudo apt install -y python3-pip openjdk-17-jdk wget unzip
          pip3 install cython==0.29.33 buildozer
      - name: Build with Logging
        id: build
        run: |
          # ساخت با لاگ کامل
          if buildozer android debug; then
            echo "BUILD_STATUS=success" >> $GITHUB_OUTPUT
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_OUTPUT
            exit 0  # باز هم workflow را سبز نگه دار
          fi
      - name: Find APK Files
        if: steps.build.outputs.BUILD_STATUS == 'success'
        run: |
          echo "=== همه فایل‌های APK ==="
          find . -type f -name "*.apk" 2>/dev/null
          echo "=== محتوای پوشه‌ها ==="
          ls -la bin/ .buildozer/android/platform/build-* 2>/dev/null || true
      - name: Upload ANY APK Found
        uses: actions/upload-artifact@v4
        with:
          name: all-apks
          path: |
            **/*.apk
            bin/
            .buildozer/
          if-no-files-found: warn
          retention-days: 1
